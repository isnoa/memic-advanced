// ==UserScript==
// @name         미밐 게시글 자동새로고침
// @namespace    http://tampermonkey.net/
// @version      1.0.1
// @description  5초마다 자동으로 새로고침 버튼을 클릭합니다 (상태 저장 기능 추가)
// @match        *://memic.at/*
// @match        *://shelter.id/*
// @grant        GM_setValue
// @grant        GM_getValue
// @author       isnoa
// ==/UserScript==

(function () {
  "use strict";

  let autoRefreshEnabled = GM_getValue("autoRefreshEnabled", false);
  let intervalId = null;
  let currentUrl = window.location.href;

  function clickRefreshButton() {
    const url = window.location.href;
    const validUrl =
      url.includes("memic.at") || (url.includes("shelter.id") && url.includes("?type=community"));

    if (!validUrl || document.hidden) return;

    const btn =
      document.querySelector(
        "button.flex.items-center.justify-center.size-6.ng-star-inserted[style='']"
      ) ||
      document.querySelectorAll(
        "button.flex.items-center.justify-center.size-6.ng-star-inserted[style='']"
      )[0];

    if (btn) {
      btn.click();
      console.log("새로고침 완료");
    }
  }

  function toggleAutoRefresh() {
    autoRefreshEnabled = !autoRefreshEnabled;
    GM_setValue("autoRefreshEnabled", autoRefreshEnabled);

    if (autoRefreshEnabled) {
      intervalId = setInterval(clickRefreshButton, 5000);
      console.log("자동 새로고침 시작");
    } else {
      clearInterval(intervalId);
      console.log("자동 새로고침 중지");
    }
    updateToggleButton();
  }

  function updateToggleButton() {
    const btn = document.getElementById("auto-refresh-toggle");
    if (btn) {
      const color = !autoRefreshEnabled ? "var(--color-on-surface-variant2)" : "var(--color-primary)";
      btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_707_161)">
<path d="M13.6584 4.19336C13.774 4.19336 13.874 4.22003 13.9584 4.27336C14.0428 4.32669 14.1162 4.43114 14.1784 4.58669L15.6784 8.45336C15.7273 8.58225 15.7273 8.69336 15.6784 8.78669C15.6295 8.88003 15.5495 8.94447 15.4384 8.98003C15.3273 9.01558 15.2162 9.02003 15.1051 8.99336C14.9984 8.96669 14.9206 8.88225 14.8717 8.74003L14.4851 7.67336H12.8051L12.4117 8.76669C12.3628 8.89558 12.2873 8.97336 12.1851 9.00003C12.0873 9.02225 11.9851 9.01558 11.8784 8.98003C11.7717 8.94447 11.694 8.88447 11.6451 8.80003C11.5962 8.71558 11.5962 8.61114 11.6451 8.48669L13.1451 4.58669C13.2028 4.43114 13.274 4.32669 13.3584 4.27336C13.4473 4.22003 13.5473 4.19336 13.6584 4.19336ZM13.6451 5.26003C13.6095 5.39336 13.574 5.51336 13.5384 5.62003C13.5073 5.72225 13.4651 5.84891 13.4117 6.00003L13.0584 6.96669H14.2317L13.8851 6.00003C13.8273 5.84447 13.7806 5.71114 13.7451 5.60003C13.714 5.48891 13.6806 5.37558 13.6451 5.26003Z" fill="${color}"/>
<path d="M2.66667 6.00018C2.84348 6.00018 3.01305 6.07042 3.13807 6.19545C3.2631 6.32047 3.33333 6.49004 3.33333 6.66685V7.33352C3.33333 8.39438 3.75476 9.4118 4.50491 10.1619C5.25505 10.9121 6.27247 11.3335 7.33333 11.3335H9.724L9.19533 10.8049C9.07389 10.6791 9.0067 10.5107 9.00822 10.3359C9.00974 10.1611 9.07985 9.99391 9.20345 9.8703C9.32706 9.7467 9.49427 9.67659 9.66907 9.67507C9.84386 9.67355 10.0123 9.74074 10.138 9.86218L11.8047 11.5288C11.9052 11.6289 11.9708 11.7586 11.992 11.8988L12 12.0069C11.9984 12.1827 11.9272 12.3507 11.802 12.4742L10.138 14.1382C10.0123 14.2596 9.84386 14.3268 9.66907 14.3253C9.49427 14.3238 9.32706 14.2537 9.20345 14.1301C9.07985 14.0065 9.00974 13.8392 9.00822 13.6645C9.0067 13.4897 9.07389 13.3213 9.19533 13.1955L9.724 12.6669H7.33333C5.91885 12.6669 4.56229 12.1049 3.5621 11.1048C2.5619 10.1046 2 8.748 2 7.33352V6.66685C2 6.49004 2.07024 6.32047 2.19526 6.19545C2.32029 6.07042 2.48986 6.00018 2.66667 6.00018ZM6.80467 1.86218C6.92965 1.9872 6.99986 2.15674 6.99986 2.33352C6.99986 2.51029 6.92965 2.67983 6.80467 2.80485L6.276 3.33352H8.66667C9.48333 3.33352 10.2593 3.51752 10.9533 3.84685C11.0324 3.8845 11.1033 3.93735 11.162 4.0024C11.2207 4.06745 11.266 4.14342 11.2953 4.22597C11.3246 4.30852 11.3374 4.39604 11.3329 4.48353C11.3283 4.57101 11.3066 4.65675 11.269 4.73585C11.2314 4.81495 11.1785 4.88586 11.1134 4.94453C11.0484 5.0032 10.9724 5.04849 10.8899 5.0778C10.7232 5.137 10.5397 5.12755 10.38 5.05152C9.84464 4.79738 9.25929 4.66596 8.66667 4.66685H6.276L6.80467 5.19552C6.92611 5.32125 6.9933 5.48965 6.99178 5.66445C6.99026 5.83925 6.92015 6.00646 6.79655 6.13006C6.67294 6.25367 6.50573 6.32378 6.33093 6.3253C6.15614 6.32682 5.98774 6.25962 5.862 6.13818L4.19533 4.47152C4.07035 4.3465 4.00014 4.17696 4.00014 4.00018C4.00014 3.82341 4.07035 3.65387 4.19533 3.52885L5.862 1.86218C5.98702 1.7372 6.15656 1.66699 6.33333 1.66699C6.51011 1.66699 6.67965 1.7372 6.80467 1.86218Z" fill="${color}"/>
</g>
<defs>
<clipPath id="clip0_707_161">
<rect width="16" height="16" fill="${color}"/>
</clipPath>
</defs>
</svg>`;
    }
  }

  function createToggleButton(retryCount = 0) {
    if (
      document.getElementById("auto-refresh-toggle") ||
      !window.location.href.includes("?type=community")
    )
      return;

    const header = document.querySelector('app-refresh-button[data-tooltip="새로고침"]')?.parentElement;

    if (!header) {
      if (retryCount < 20) {
        setTimeout(() => createToggleButton(retryCount + 1), 500);
      }
      return;
    }

    const btn = document.createElement("button");
    btn.id = "auto-refresh-toggle";
    btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_707_161)"><path d="M13.6584 4.19336C13.774 4.19336 13.874 4.22003 13.9584 4.27336C14.0428 4.32669 14.1162 4.43114 14.1784 4.58669L15.6784 8.45336C15.7273 8.58225 15.7273 8.69336 15.6784 8.78669C15.6295 8.88003 15.5495 8.94447 15.4384 8.98003C15.3273 9.01558 15.2162 9.02003 15.1051 8.99336C14.9984 8.96669 14.9206 8.88225 14.8717 8.74003L14.4851 7.67336H12.8051L12.4117 8.76669C12.3628 8.89558 12.2873 8.97336 12.1851 9.00003C12.0873 9.02225 11.9851 9.01558 11.8784 8.98003C11.7717 8.94447 11.694 8.88447 11.6451 8.80003C11.5962 8.71558 11.5962 8.61114 11.6451 8.48669L13.1451 4.58669C13.2028 4.43114 13.274 4.32669 13.3584 4.27336C13.4473 4.22003 13.5473 4.19336 13.6584 4.19336ZM13.6451 5.26003C13.6095 5.39336 13.574 5.51336 13.5384 5.62003C13.5073 5.72225 13.4651 5.84891 13.4117 6.00003L13.0584 6.96669H14.2317L13.8851 6.00003C13.8273 5.84447 13.7806 5.71114 13.7451 5.60003C13.714 5.48891 13.6806 5.37558 13.6451 5.26003Z" fill="var(--color-on-surface-variant2)"/><path d="M2.66667 6.00018C2.84348 6.00018 3.01305 6.07042 3.13807 6.19545C3.2631 6.32047 3.33333 6.49004 3.33333 6.66685V7.33352C3.33333 8.39438 3.75476 9.4118 4.50491 10.1619C5.25505 10.9121 6.27247 11.3335 7.33333 11.3335H9.724L9.19533 10.8049C9.07389 10.6791 9.0067 10.5107 9.00822 10.3359C9.00974 10.1611 9.07985 9.99391 9.20345 9.8703C9.32706 9.7467 9.49427 9.67659 9.66907 9.67507C9.84386 9.67355 10.0123 9.74074 10.138 9.86218L11.8047 11.5288C11.9052 11.6289 11.9708 11.7586 11.992 11.8988L12 12.0069C11.9984 12.1827 11.9272 12.3507 11.802 12.4742L10.138 14.1382C10.0123 14.2596 9.84386 14.3268 9.66907 14.3253C9.49427 14.3238 9.32706 14.2537 9.20345 14.1301C9.07985 14.0065 9.00974 13.8392 9.00822 13.6645C9.0067 13.4897 9.07389 13.3213 9.19533 13.1955L9.724 12.6669H7.33333C5.91885 12.6669 4.56229 12.1049 3.5621 11.1048C2.5619 10.1046 2 8.748 2 7.33352V6.66685C2 6.49004 2.07024 6.32047 2.19526 6.19545C2.32029 6.07042 2.48986 6.00018 2.66667 6.00018ZM6.80467 1.86218C6.92965 1.9872 6.99986 2.15674 6.99986 2.33352C6.99986 2.51029 6.92965 2.67983 6.80467 2.80485L6.276 3.33352H8.66667C9.48333 3.33352 10.2593 3.51752 10.9533 3.84685C11.0324 3.8845 11.1033 3.93735 11.162 4.0024C11.2207 4.06745 11.266 4.14342 11.2953 4.22597C11.3246 4.30852 11.3374 4.39604 11.3329 4.48353C11.3283 4.57101 11.3066 4.65675 11.269 4.73585C11.2314 4.81495 11.1785 4.88586 11.1134 4.94453C11.0484 5.0032 10.9724 5.04849 10.8899 5.0778C10.7232 5.137 10.5397 5.12755 10.38 5.05152C9.84464 4.79738 9.25929 4.66596 8.66667 4.66685H6.276L6.80467 5.19552C6.92611 5.32125 6.9933 5.48965 6.99178 5.66445C6.99026 5.83925 6.92015 6.00646 6.79655 6.13006C6.67294 6.25367 6.50573 6.32378 6.33093 6.3253C6.15614 6.32682 5.98774 6.25962 5.862 6.13818L4.19533 4.47152C4.07035 4.3465 4.00014 4.17696 4.00014 4.00018C4.00014 3.82341 4.07035 3.65387 4.19533 3.52885L5.862 1.86218C5.98702 1.7372 6.15656 1.66699 6.33333 1.66699C6.51011 1.66699 6.67965 1.7372 6.80467 1.86218Z" fill="var(--color-on-surface-variant2)"/></g><defs><clipPath id="clip0_707_161"><rect width="16" height="16" fill="var(--color-on-surface-variant2)"/></clipPath></defs></svg>`;
    btn.className =
      "bg-on-background-variant2 text-on-surface-variant2 flex size-7 items-center justify-center rounded-lg";
    btn.onclick = toggleAutoRefresh;
    btn.setAttribute("data-tooltip", "자동 새로고침");

    header.insertBefore(btn, header.firstChild);

    // 저장된 상태에 따라 초기화
    if (autoRefreshEnabled) {
      intervalId = setInterval(clickRefreshButton, 5000);
    }
    updateToggleButton();
  }

  function init() {
    createToggleButton();
    document.addEventListener("visibilitychange", () => {
      if (!document.hidden && autoRefreshEnabled) setTimeout(clickRefreshButton, 1000);
    });
  }

  document.readyState === "loading" ? document.addEventListener("DOMContentLoaded", init) : init();

  // SPA 대응
  new MutationObserver(() => {
    if (window.location.href !== currentUrl) {
      currentUrl = window.location.href;
      setTimeout(createToggleButton, 1000);
    }
  }).observe(document, { subtree: true, childList: true });
})();
